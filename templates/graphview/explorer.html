{% extends "graphview/base.html" %}

{% block javascript_imports %}
<script language="javascript" src="/site_media/raphael-min.js"></script>
<script language="javascript" src="/site_media/graph-canvas.js"></script>
{% endblock %}

{% block javascript %}
    <script type="text/javascript" charset="utf-8"> 
        var selected_node;
        var selected_edge;
        var terminal;
        var gdata = eval({{ json_graph|safe }});
        var node_fields_shown = ["text-type", "text", "degree",
            "clustering", "original-degree", "original-clustering"];
        var edge_fields_shown = ["node1", "node2"];

        function delete_node() {
            if (multiselection) {
                multiselection = false;
                url = "delete_nodes/" + multiselection_table;
            } else {
                url = "delete_nodes/" + selected_node;
            }
            self.location.href=url;
        }

        function delete_edge() {
            edge = gdata.edges[selected_edge];
            url = "delete_edges/" + edge['node1'] + "," + edge['node2'];
            self.location.href=url;
        }

        function expand_node() {
            if (multiselection) {
                multiselection = false;
                url = "expand_nodes/" + multiselection_table;
            } else {
                url = "expand_nodes/" + selected_node;
            }
            self.location.href=url;
        }

        function toggle_nodes(node_types) {
            url = "toggle_nodes/" + node_types;
            self.location.href=url;
        }

        function execute_query() {
            query = document.getElementById("query").value;
            url = "interactor_query/" + query;
            self.location.href=url;
        }

        function multi_select() {
            if (!multiselection) {
                multiselection_table = []
                multiselection_table.push(selected_node);
                multiselection = true;
            } else {
                multiselection = false;
            }
        }
    </script> 
{% endblock %}

{% block raphael %}
    <script type="text/javascript" charset="utf-8">
        window.onload = function () {
            var rafael = new RaphaelGraph(gdata, node_fields_shown, edge_fields_shown);
            rafael.draw();
            terminalWidget = document.getElementById('query');
            terminalWidget.onkeydown = onKeyDown;
        }
    </script>
{% endblock %}

{% block menu %}
    <div id="menu">
        <h2>Plexigraph</h2>
        <h3>Dataset</h3>
            <table class="dataset">
                <tr>
                    <td>Name: </td>
                    <td>{{ dataset.name }}</td>
                </tr>
                <tr>
                    <td>Description: </td>
                    <td>{{ dataset.description }}</td>
                </tr>
                {% for key, value in metadata_list %}
                    <tr>
                        <td>
                            {{ key }}
                        </td>
                        <td>
                            {{ value }}
                        </td>
                    </tr>
                {% endfor %}
            </table>
            <h3>Topics</h3>
            <div class="topics">
                {% for key, style in node_style_list %}
                    <input type="checkbox" onclick="toggle_nodes({{ key }})" 
                        {% if style.show %}checked{% endif %}>
                            <span style="color:{{ style.color }}">
                                {{ style.label }}
                            </span><br>
                {% endfor %}
            </div>
    </div>
{% endblock %}

{% block content %}
    <div id="content">
        <div id="canvas"> </div>
        <div id="info">
            {% include "graphview/actions.html" %}
            {% include "graphview/infoTable.html" %}
            <div id="floating_node_menu" onmouseout="this.style.display='none'"
                               onclick="this.style.display='none'"
                               onmouseover="this.style.display='block'">
                <input id="delete_node" type="button" value="Delete node" onclick="delete_node()"/>
                <br/>
                <input id="expand_node" type="button" value="Expand node" onclick="expand_node()"/>
                <br/>
                <input id="multiselect_node" type="button" value="Multi selection" onclick="multi_select()"/>
            </div>
            <div id="floating_edge_menu" onmouseout="this.style.display='none'"
                               onclick="this.style.display='none'"
                               onmouseover="this.style.display='block'">
                <input id="delete_edge" type="button" value="Delete node" onclick="delete_edge()"/>
                <br/>
            </div>
        </div>
    </div>
{% endblock %}

{% block bottombar %}
<div id="commandbar">
    <input id="query" type="text" size="60"/>
    <input id="btn_query" type="button" value="Query" onclick="execute_query()"/>
</div>
{% endblock %}
